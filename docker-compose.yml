services:
  # 첫 번째 Django 컨테이너
  web1:
    build: ./app
    container_name: django-web1
    hostname: django-web1
    # 외부로 포트를 노출하지 않고 컨테이너 네트워크 내에서만 8888 사용
    expose:
      - "8888"
    depends_on:
      crate-node1:
        condition: service_healthy
    networks:
      - app-network
    restart: always

  # 두 번째 Django 컨테이너
  web2:
    build: ./app
    container_name: django-web2
    hostname: django-web2
    expose:
      - "8888"
    depends_on:
      crate-node1:
        condition: service_healthy
    networks:
      - app-network
    restart: always

  # 세 번째 Django 컨테이너
  web3:
    build: ./app
    container_name: django-web3
    hostname: django-web3
    expose:
      - "8888"
    depends_on:
      crate-node1:
        condition: service_healthy
    networks:
      - app-network
    restart: always

  # Nginx 로드 밸런서
  nginx:
    image: nginx:latest
    container_name: django-nginx
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    ports:
      # 외부의 8888 포트를 Nginx의 80번 포트(nginx.conf에서 설정한 listen 80)로 연결
      - "8888:80"
    depends_on:
      - web1
      - web2
      - web3
    networks:
      - app-network
    restart: always

  # CrateDB Node 1 (Seed / Master)
  crate-node1:
    image: crate:latest
    container_name: crate-node1
    ports:
      - "4200:4200"
      - "5432:5432"
    command: >
      crate
      -Cnetwork.host=_site_
      -Ccluster.name=crate-cluster
      -Cnode.name=crate-node1
      -Cdiscovery.seed_hosts=crate-node2,crate-node3
      -Ccluster.initial_master_nodes=crate-node1,crate-node2,crate-node3
      -Cgateway.expected_data_nodes=3
      -Cgateway.recover_after_data_nodes=2
    healthcheck:
      test: ["CMD-SHELL", "crash --host crate-node1:4200 -c 'SELECT 1'"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - app-network
    restart: always

  # CrateDB Node 2
  crate-node2:
    image: crate:latest
    container_name: crate-node2
    command: >
      crate
      -Cnetwork.host=_site_
      -Ccluster.name=crate-cluster
      -Cnode.name=crate-node2
      -Cdiscovery.seed_hosts=crate-node1,crate-node3
      -Ccluster.initial_master_nodes=crate-node1,crate-node2,crate-node3
      -Cgateway.expected_data_nodes=3
      -Cgateway.recover_after_data_nodes=2
    networks:
      - app-network
    restart: always

  # CrateDB Node 3
  crate-node3:
    image: crate:latest
    container_name: crate-node3
    command: >
      crate
      -Cnetwork.host=_site_
      -Ccluster.name=crate-cluster
      -Cnode.name=crate-node3
      -Cdiscovery.seed_hosts=crate-node1,crate-node2
      -Ccluster.initial_master_nodes=crate-node1,crate-node2,crate-node3
      -Cgateway.expected_data_nodes=3
      -Cgateway.recover_after_data_nodes=2
    networks:
      - app-network
    restart: always

  # ========================================
  # Redis Cluster (6 nodes: 3 masters + 3 replicas)
  # ========================================

  # Redis Node 1 (Master)
  redis-node1:
    image: redis:latest
    container_name: redis-node1
    command: >
      redis-server /usr/local/etc/redis/redis.conf
      --port 7001
      --cluster-announce-ip 172.28.0.21
      --cluster-announce-port 7001
      --cluster-announce-bus-port 17001
    volumes:
      - ./redis/redis.conf:/usr/local/etc/redis/redis.conf:ro
    ports:
      - "7001:7001"
    networks:
      app-network:
        ipv4_address: 172.28.0.21
    restart: always

  # Redis Node 2 (Master)
  redis-node2:
    image: redis:latest
    container_name: redis-node2
    command: >
      redis-server /usr/local/etc/redis/redis.conf
      --port 7002
      --cluster-announce-ip 172.28.0.22
      --cluster-announce-port 7002
      --cluster-announce-bus-port 17002
    volumes:
      - ./redis/redis.conf:/usr/local/etc/redis/redis.conf:ro
    ports:
      - "7002:7002"
    networks:
      app-network:
        ipv4_address: 172.28.0.22
    restart: always

  # Redis Node 3 (Master)
  redis-node3:
    image: redis:latest
    container_name: redis-node3
    command: >
      redis-server /usr/local/etc/redis/redis.conf
      --port 7003
      --cluster-announce-ip 172.28.0.23
      --cluster-announce-port 7003
      --cluster-announce-bus-port 17003
    volumes:
      - ./redis/redis.conf:/usr/local/etc/redis/redis.conf:ro
    ports:
      - "7003:7003"
    networks:
      app-network:
        ipv4_address: 172.28.0.23
    restart: always

  # Redis Node 4 (Replica)
  redis-node4:
    image: redis:latest
    container_name: redis-node4
    command: >
      redis-server /usr/local/etc/redis/redis.conf
      --port 7004
      --cluster-announce-ip 172.28.0.24
      --cluster-announce-port 7004
      --cluster-announce-bus-port 17004
    volumes:
      - ./redis/redis.conf:/usr/local/etc/redis/redis.conf:ro
    ports:
      - "7004:7004"
    networks:
      app-network:
        ipv4_address: 172.28.0.24
    restart: always

  # Redis Node 5 (Replica)
  redis-node5:
    image: redis:latest
    container_name: redis-node5
    command: >
      redis-server /usr/local/etc/redis/redis.conf
      --port 7005
      --cluster-announce-ip 172.28.0.25
      --cluster-announce-port 7005
      --cluster-announce-bus-port 17005
    volumes:
      - ./redis/redis.conf:/usr/local/etc/redis/redis.conf:ro
    ports:
      - "7005:7005"
    networks:
      app-network:
        ipv4_address: 172.28.0.25
    restart: always

  # Redis Node 6 (Replica)
  redis-node6:
    image: redis:latest
    container_name: redis-node6
    command: >
      redis-server /usr/local/etc/redis/redis.conf
      --port 7006
      --cluster-announce-ip 172.28.0.26
      --cluster-announce-port 7006
      --cluster-announce-bus-port 17006
    volumes:
      - ./redis/redis.conf:/usr/local/etc/redis/redis.conf:ro
    ports:
      - "7006:7006"
    networks:
      app-network:
        ipv4_address: 172.28.0.26
    restart: always

  # Redis Cluster 초기화 컨테이너
  redis-cluster-init:
    image: redis:latest
    container_name: redis-cluster-init
    depends_on:
      - redis-node1
      - redis-node2
      - redis-node3
      - redis-node4
      - redis-node5
      - redis-node6
    networks:
      - app-network
    command: >
      sh -c "
        echo 'Waiting for Redis nodes to be ready...' &&
        for i in 1 2 3 4 5 6; do
          port=$$((7000 + i));
          ip=172.28.0.$$((20 + i));
          while ! redis-cli -h $$ip -p $$port ping > /dev/null 2>&1; do
            echo \"Waiting for $$ip:$$port...\";
            sleep 1;
          done;
          echo \"$$ip:$$port is ready!\";
        done &&
        echo 'All Redis nodes are ready. Creating cluster...' &&
        redis-cli --cluster create 172.28.0.21:7001 172.28.0.22:7002 172.28.0.23:7003 172.28.0.24:7004 172.28.0.25:7005 172.28.0.26:7006 --cluster-replicas 1 --cluster-yes &&
        echo 'Redis Cluster created successfully!' &&
        redis-cli -h 172.28.0.21 -p 7001 cluster info &&
        redis-cli -h 172.28.0.21 -p 7001 cluster nodes
      "
    restart: "no"

networks:
  app-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
