events {}

http {
    # =================================================================
    # [로드 밸런싱 그룹 정의]
    # 테스트하고 싶은 방식에 따라 proxy_pass 부분을 변경하세요.
    # =================================================================

    # 1. Round Robin (기본값)
    # - 순서대로 하나씩 분배
    upstream django_round_robin {
        server web1:8888;
        server web2:8888;
        server web3:8888;
    }

    # 2. Least Connections
    # - 연결 수가 가장 적은 서버로 분배
    upstream django_least_conn {
        least_conn;
        server web1:8888;
        server web2:8888;
        server web3:8888;
    }

    # 3. IP Hash
    # - 사용자 IP에 따라 서버 고정 (새로고침해도 같은 서버)
    upstream django_ip_hash {
        ip_hash;
        server web1:8888;
        server web2:8888;
        server web3:8888;
    }

    # 4. Weighted (가중치)
    # - web1이 다른 서버보다 3배 더 많은 요청을 받음
    upstream django_weighted {
        server web1:8888 weight=3;
        server web2:8888;
        server web3:8888;
    }

    server {
        listen 80;

        location / {
            # =============================================================
            # [알고리즘 선택]
            # 아래 중 원하는 그룹의 주석(#)을 제거하여 활성화하세요.
            # =============================================================
            
            proxy_pass http://django_round_robin;
            # proxy_pass http://django_least_conn;
            # proxy_pass http://django_ip_hash;
            # proxy_pass http://django_weighted;

            # -------------------------------------------------------------
            # [헤더 전달 설정]
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
    }
}
