events {}

http {
    # 1. 로드 밸런싱을 위한 서버 그룹 정의
    upstream django_cluster {
        # Docker 네트워크 안에서 컨테이너 이름(web1, web2, web3)으로 통신합니다.
        # Nginx가 이 세 대의 서버에 요청을 골고루 분산시킵니다.
        server web1:8888;
        server web2:8888;
        server web3:8888;
    }

    server {
        # 2. 사용자가 접속할 포트 (기본 웹 포트인 80번 사용)
        listen 80;

        # 3. 모든 경로("/")에 대한 요청 처리 규칙
        location / {
            # 위에서 정의한 django_cluster 그룹으로 요청을 전달(프록시)합니다.
            proxy_pass http://django_cluster;

            # 4. Django 서버가 실제 요청자의 정보를 알 수 있도록 헤더 정보를 전달합니다.
            
            # 원래 요청된 호스트 이름을 전달 (예: localhost)
            proxy_set_header Host $host;
            
            # 실제 요청을 보낸 사용자의 IP 주소를 전달
            proxy_set_header X-Real-IP $remote_addr;
            
            # 거쳐온 프록시 서버들의 IP 목록을 전달
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
    }
}